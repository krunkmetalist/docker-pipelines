# Use the official Windows Server Core image
FROM mcr.microsoft.com/windows/servercore:ltsc2019

# Install Chocolatey
RUN powershell -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command "iex ((new-object net.webclient).DownloadString('https://chocolatey.org/install.ps1'))"

# Install Node.js, Ruby, Java, and other dependencies using Chocolatey
RUN choco install -y nodejs-lts --version=14.17.0 \
    && choco install -y ruby --version=3.2.1 \
    && choco install -y jdk17

# Install Visual Studio Build Tools with required workloads
RUN powershell -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command "Invoke-WebRequest -Uri https://aka.ms/vs/16/release/vs_buildtools.exe -OutFile vs_buildtools.exe; \
    Start-Process vs_buildtools.exe -ArgumentList '--quiet --wait --norestart --nocache --add Microsoft.VisualStudio.Workload.VCTools --add Microsoft.VisualStudio.Workload.AzureBuildTools' -NoNewWindow -Wait"

# Install Visual Studio extension for installer creation
# (Assuming a VSIX file is available or can be downloaded)
# RUN powershell -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command "Invoke-WebRequest -Uri http://<VSIX_URL> -OutFile installer_extension.vsix; \
#    & 'C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\Common7\IDE\VSIXInstaller.exe' -quiet -a installer_extension.vsix"

# Download Jenkins agent
RUN powershell -Command \
    Invoke-WebRequest -Uri 'http://<JENKINS_URL>/jnlpJars/agent.jar' -OutFile 'C:\\agent.jar'

# Set the entrypoint to run the Jenkins agent
ENTRYPOINT ["java", "-jar", "C:\\agent.jar"]